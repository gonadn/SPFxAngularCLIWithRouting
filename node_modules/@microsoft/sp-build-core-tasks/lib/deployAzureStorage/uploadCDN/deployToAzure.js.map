{"version":3,"sources":["deployAzureStorage/uploadCDN/deployToAzure.ts"],"names":[],"mappings":"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","file":"deployAzureStorage/uploadCDN/deployToAzure.js","sourcesContent":["/**\r\n * @file deployToAzure.ts\r\n * @Copyright (c) Microsoft Corporation.  All rights reserved.\r\n *\r\n * Uploads source files to an Azure Blob Storage instance\r\n */\r\n\r\nimport glob = require('glob');\r\nimport colors = require('colors');\r\n\r\nimport { IDeployAzureStorageTaskConfig } from '../DeployAzureStorageTask';\r\nimport ensureBlobService from './../../utilities/azureStorage/ensureBlobService';\r\nimport ensureContainer from './../../utilities/azureStorage/ensureContainer';\r\nimport uploadFilesToAzure, {\r\n  IUploadableFile\r\n} from './../../utilities/azureStorage/uploadFilesToAzure';\r\nimport { joinUrlSegments } from './../../utilities/url';\r\n\r\ninterface IGlobOptions {\r\n  cwd?: string;\r\n}\r\n\r\n/**\r\n * Uses glob to expand the filepath glob into a list of resolved file paths\r\n */\r\nfunction loadSourceFiles(globs: string, cwd?: string): Promise<string[]> {\r\n  return new Promise<string[]>((resolve: (files: string[]) => void, reject: (error: Error) => void) => {\r\n    const options: IGlobOptions = cwd ? { cwd: cwd } : {};\r\n\r\n    glob(globs, options, (err: Error, matches: string[]) => {\r\n      if (err) {\r\n        reject(err);\r\n      } else {\r\n        resolve(matches || []);\r\n      }\r\n    });\r\n  });\r\n}\r\n\r\n/**\r\n * Deploys all the files in a certain directory to a specific Azure Blob Storage instance\r\n */\r\nexport default function deployToAzure(config: IDeployAzureStorageTaskConfig,\r\n                                      log: (str: string) => void = console.log,\r\n                                      /* tslint:disable-next-line:no-any */\r\n                                      logError: (error: any) => void = console.error): Promise<void> {\r\n  if (!config.container) {\r\n    return new Promise<void>((complete: () => void, reject: (error: Error) => void) => {\r\n      reject(new Error('Config file missing container name!'));\r\n    });\r\n  }\r\n\r\n  if (!config.account) {\r\n    return new Promise<void>((complete: () => void, reject: (error: Error) => void) => {\r\n      reject(new Error('Config file missing Azure account name!'));\r\n    });\r\n  }\r\n\r\n  if (!config.accessKey) {\r\n    return new Promise<void>((complete: () => void, reject: (error: Error) => void) => {\r\n      reject(new Error('Config file missing Azure access key!'));\r\n    });\r\n  }\r\n\r\n  log(`Uploading files '${config.uploadPath}' from directory '${config.workingDir}' to Azure`);\r\n\r\n  return loadSourceFiles(config.uploadPath, config.workingDir)\r\n    .then((files: string[]) => {\r\n        return ensureBlobService(config.account, config.accessKey)\r\n          .then((blobService: IAzureBlobService) => ensureContainer(blobService, config.container, undefined, log))\r\n          .then((blobService: IAzureBlobService) => {\r\n            const filesToUpload: IUploadableFile[] = files.map((filename: string) => {\r\n              return {\r\n                azurePath: filename,\r\n                localPath: config.workingDir + filename\r\n              };\r\n            });\r\n            return uploadFilesToAzure(blobService, config.container, filesToUpload, log);\r\n          })\r\n          .then(() => {\r\n            log(colors.green('Upload complete!\\n'));\r\n            log(`Access your files at: ${getAzureStorageUrl(config.account, config.container)}\\n`);\r\n          }, (error: Error) => {\r\n            logError(error);\r\n\r\n            if (error.stack) {\r\n              logError(error.stack);\r\n            }\r\n       });\r\n    });\r\n}\r\n\r\nexport function getAzureStorageUrl(accountName: string, containerName: string): string {\r\n  return joinUrlSegments(`https://${accountName}.blob.core.windows.net`, containerName || '');\r\n}\r\n"],"sourceRoot":"..\\..\\..\\src"}