{"version":3,"sources":["KarmaTask.ts"],"names":[],"mappings":"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","file":"KarmaTask.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { GulpTask, IBuildConfig } from '@microsoft/gulp-core-build';\r\n\r\nimport * as os from 'os';\r\nimport * as fs from 'fs';\r\nimport * as Gulp from 'gulp';\r\nimport * as path from 'path';\r\nimport * as KarmaType from 'karma';\r\n\r\nexport interface IKarmaTaskConfig {\r\n  configPath: string;\r\n\r\n  /**\r\n   * By default, test failures generate build warnings in non-production builds. Setting\r\n   * this value to true ensures all test failures will create build failures.\r\n   */\r\n  failBuildOnErrors: boolean;\r\n\r\n  /**\r\n   * If specified, a \"tests.js\" file will be created in the temp folder using\r\n   *  this RegExp to locate test files.\r\n   */\r\n  testMatch?: RegExp | string;\r\n}\r\n\r\nexport class KarmaTask extends GulpTask<IKarmaTaskConfig> {\r\n  private _resources: Object;\r\n\r\n  constructor() {\r\n    super(\r\n      'karma',\r\n      {\r\n        configPath: './karma.config.js',\r\n        testMatch: /.+\\.test\\.js?$/,\r\n        failBuildOnErrors: false\r\n      }\r\n    );\r\n  }\r\n\r\n  public get resources(): Object {\r\n    if (!this._resources) {\r\n      this._resources = {\r\n        bindPolyfillPath: require.resolve('phantomjs-polyfill/bind-polyfill.js'),\r\n        istanbulInstrumenterLoaderPath: require.resolve('istanbul-instrumenter-loader'),\r\n        plugins: [\r\n          require('karma-webpack'),\r\n          require('karma-mocha'),\r\n          require('karma-coverage'),\r\n          require('karma-mocha-clean-reporter'),\r\n          require('karma-phantomjs-launcher'),\r\n          require('karma-sinon-chai')\r\n        ]\r\n      };\r\n    }\r\n\r\n    return this._resources;\r\n  }\r\n\r\n  public loadSchema(): Object {\r\n    return require('./karma.schema.json');\r\n  }\r\n\r\n  public getCleanMatch(buildConfig: IBuildConfig, taskConfig: IKarmaTaskConfig = this.taskConfig): string[] {\r\n    return [\r\n      path.join(buildConfig.tempFolder, 'tests.js')\r\n    ];\r\n  }\r\n\r\n  public isEnabled(buildConfig: IBuildConfig): boolean {\r\n    return (\r\n      super.isEnabled(buildConfig) &&\r\n      !buildConfig.jestEnabled &&\r\n      this.taskConfig.configPath !== null // tslint:disable-line:no-null-keyword\r\n    );\r\n  }\r\n\r\n  public executeTask(gulp: typeof Gulp, completeCallback: (error?: Error | string) => void): void {\r\n    const { configPath }: IKarmaTaskConfig = this.taskConfig;\r\n\r\n    if (configPath && !this.fileExists(configPath)) {\r\n      const shouldInitKarma: boolean = (process.argv.indexOf('--initkarma') > -1);\r\n\r\n      if (!shouldInitKarma) {\r\n        this.logWarning(\r\n          `No karma config has been provided. ` +\r\n          `Run again using --initkarma to create a default config, or call ` +\r\n          `karma.setConfig({ configPath: null }) in your gulpfile.`);\r\n      } else {\r\n        this.copyFile(path.resolve(__dirname, '../karma.config.js'));\r\n\r\n        // install dev dependencies?\r\n        // phantomjs-polyfill?\r\n        //\r\n        // install typings for mocha/chai/sinon?\r\n      }\r\n\r\n      completeCallback();\r\n    } else {\r\n      // Normalize the match expression if one was specified\r\n      const { testMatch }: IKarmaTaskConfig = this.taskConfig;\r\n      if (testMatch) {\r\n        let normalizedMatch: RegExp;\r\n\r\n        if (typeof testMatch === 'string') {\r\n          try {\r\n            normalizedMatch = new RegExp(testMatch as string);\r\n          } catch (error) {\r\n            completeCallback('There was an issue parsing your testMatch regular expression: ' + error.toString());\r\n            return;\r\n          }\r\n        } else if (testMatch instanceof RegExp) {\r\n          normalizedMatch = testMatch;\r\n        } else {\r\n          completeCallback('The testMatch regular expression is invalid');\r\n          return;\r\n        }\r\n\r\n        // tslint:disable:max-line-length\r\n        const testsJsFileContents: string = [\r\n          `var context = require.context('${path.posix.join('..', this.buildConfig.libFolder)}', true, ${normalizedMatch.toString()});`,\r\n          `context.keys().forEach(context);`,\r\n          `module.exports = context;`\r\n        ].join(os.EOL);\r\n        // tslint:enable:max-line-length\r\n\r\n        const tempFolder: string = path.join(this.buildConfig.rootPath, this.buildConfig.tempFolder);\r\n        if (!fs.existsSync(tempFolder)) {\r\n          fs.mkdirSync(tempFolder);\r\n        }\r\n        fs.writeFileSync(path.join(tempFolder, 'tests.js'), testsJsFileContents);\r\n      }\r\n\r\n      const karma: typeof KarmaType = require('karma'); // tslint:disable-line\r\n      const server: KarmaType.Server = karma.Server;\r\n      const singleRun: boolean = (process.argv.indexOf('--debug') === -1);\r\n      const matchIndex: number = (process.argv.indexOf('--match'));\r\n      const matchString: string = (matchIndex === -1) ? '' : process.argv[matchIndex + 1];\r\n\r\n      new server({\r\n        client: {\r\n          mocha: {\r\n            grep: matchString\r\n          }\r\n        },\r\n        configFile: this.resolvePath(configPath),\r\n        singleRun: singleRun\r\n      }, (exitCode) => {\r\n        if (exitCode) {\r\n          const message: string = 'Error(s) occured during karma.';\r\n          if (this.buildConfig.production || this.taskConfig.failBuildOnErrors) {\r\n            completeCallback(message);\r\n          } else {\r\n            this.logWarning(message);\r\n            completeCallback();\r\n          }\r\n        } else {\r\n          completeCallback();\r\n        }\r\n      }).start();\r\n    }\r\n  }\r\n}\r\n"],"sourceRoot":"..\\src"}