"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const gulp_core_build_sass_1 = require("@microsoft/gulp-core-build-sass");
const gulp_core_build_serve_1 = require("@microsoft/gulp-core-build-serve");
const gulp_core_build_webpack_1 = require("@microsoft/gulp-core-build-webpack");
const gulp_core_build_karma_1 = require("@microsoft/gulp-core-build-karma");
const gulp_core_build_1 = require("@microsoft/gulp-core-build");
const spBuildCoreTasks = require("@microsoft/sp-build-core-tasks");
const ConfigureWebpackTask_1 = require("@microsoft/sp-build-core-tasks/lib/configureWebpack/ConfigureWebpackTask");
const sp_build_common_1 = require("@microsoft/sp-build-common");
const WebBuildRigConstants_1 = require("./WebBuildRigConstants");
class SPWebBuildRig extends sp_build_common_1.SPBuildRig {
    initialize(gulp) {
        super.initialize(gulp);
    }
    getYargs() {
        // tslint:disable:max-line-length
        return super.getYargs()
            .option('debug', {
            describe: 'runs tests in unit mode'
        })
            .option('upgrade', {
            describe: 'upgrades outdated files in the project'
        })
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle, 'build, localize, and bundle the project')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.deployAzureStorage, 'upload the assets to a development CDN')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.packageSolution, 'package the project into a SPPKG')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.test, 'build, localize, and bundle the project and run tests, and verify the coverage')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.serve, 'build and bundle the project and run the development server')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.devDeploy, 'deploy the current project to a development Azure CDN for sharing builds with colleagues.')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.trustDevCert, 'generates and trusts a development certificate if one isn\'t already present')
            .command(WebBuildRigConstants_1.WebBuildRigConstants.tasks.untrustDevCert, 'untrusts and deletes the development certificate if it exists')
            .command('default', 'equivalent to bundle and test')
            .option('entry', {
            describe: 'Select which entries should be bundled. This can match the GUID or the alias of the entry.',
            string: true
        });
        // tslint:enable:max-line-length
    }
    setupSharedConfig() {
        super.setupSharedConfig();
        gulp_core_build_webpack_1.default.taskConfig.webpack = require('webpack');
        gulp_core_build_sass_1.default.mergeConfig({
            dropCssFiles: true,
            warnOnNonCSSModules: true
        });
        gulp_core_build_karma_1.default.setConfig({
            configPath: path.resolve(path.join(__dirname, 'karma', 'karma.config.js'))
        });
        spBuildCoreTasks.configureWebpack.mergeConfig({
            webpack: gulp_core_build_webpack_1.default,
            configureExternalBundlingWebpackTask: spBuildCoreTasks.configureExternalBundlingWebpack
        });
        spBuildCoreTasks.configureExternalBundlingWebpack.mergeConfig({
            webpack: gulp_core_build_webpack_1.default,
            configureWebpackTask: spBuildCoreTasks.configureWebpack,
            debugLocale: this.args.locale
        });
        spBuildCoreTasks.writeManifests.mergeConfig({
            debugLocale: this.args.locale
        });
        gulp_core_build_1.copyStaticAssets.setConfig({
            includeExtensions: ConfigureWebpackTask_1.fileLoaderExts
        });
        if (this.args.production) {
            spBuildCoreTasks.copyAssets.mergeConfig({
                extsToIgnore: ['.map', '.stats.json', '.stats.html']
            });
        }
    }
    finalizeSharedConfig() {
        super.finalizeSharedConfig();
        if (this.args.minimal) {
            this._disableTasks(gulp_core_build_karma_1.default, spBuildCoreTasks.casperJSRunner);
        }
        const serve = spBuildCoreTasks.serve;
        spBuildCoreTasks.writeManifests.mergeConfig({
            deployCdnPath: spBuildCoreTasks.copyAssets.taskConfig.deployCdnPath,
            debugBasePath: `${serve.taskConfig.https ? 'https' : 'http'}://${serve.taskConfig.hostname}:${serve.taskConfig.port}/`
        });
        if (this.args.production) {
            spBuildCoreTasks.packageSolution.mergeConfig({
                paths: {
                    distributionDir: spBuildCoreTasks.copyAssets.taskConfig.deployCdnPath
                }
            });
        }
        // pipe the cdnBasePath into package solution, so that it can warn
        spBuildCoreTasks.packageSolution.cdnBasePath =
            spBuildCoreTasks.writeManifests.taskConfig.cdnBasePath;
    }
    getTasks() {
        const result = super.getTasks();
        result.set(sp_build_common_1.BuildRigConstants.tasks.build, {
            executable: this.getBuildTask()
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle, {
            executable: this.getBundleTask()
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.devDeploy, {
            executable: spBuildCoreTasks.devDeploy,
            arguments: (yargs) => {
                return yargs
                    .option('rush', {
                    describe: 'use all projects specified in the repo\'s rush.json'
                });
            }
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.deployAzureStorage, {
            executable: spBuildCoreTasks.deployAzureStorage
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.packageSolution, {
            executable: spBuildCoreTasks.packageSolution
        });
        // @todo VSO #167343
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.test, {
            executable: this.getTestTask(),
            arguments: (yargs) => {
                return yargs
                    .option('debug', {
                    describe: 'run tests in debug mode'
                })
                    .option('match', {
                    describe: 'regular expression. Only run tests that match',
                    string: true
                });
            }
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.serve, {
            executable: sp_build_common_1.serial(spBuildCoreTasks.serve, sp_build_common_1.watch(['src/**/*.{ts,tsx,scss,resx,js,json,html}',
                '!src/**/*.{scss.ts,resx.ts}'], sp_build_common_1.serial(result.get(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle).executable, gulp_core_build_serve_1.reload))),
            arguments: (yargs) => {
                return yargs
                    .option('port', {
                    description: 'the port to serve on should be the next argument (e.g. "--port 80")'
                })
                    .option('nobrowser', {
                    description: 'don\'t open a browser after initial bundle'
                })
                    .option('config', {
                    description: 'use this option to specify which configuration to use in the serve.json file'
                });
            }
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.trustDevCert, {
            executable: gulp_core_build_serve_1.trustDevCert
        });
        result.set(WebBuildRigConstants_1.WebBuildRigConstants.tasks.untrustDevCert, {
            executable: gulp_core_build_serve_1.untrustDevCert
        });
        result.set(sp_build_common_1.BuildRigConstants.tasks.default, result.get(WebBuildRigConstants_1.WebBuildRigConstants.tasks.bundle));
        return result;
    }
    getConfigureRigTask() {
        return spBuildCoreTasks.configureRig;
    }
    getTestTask() {
        let testTask = WebBuildRigConstants_1.WebBuildRigConstants.flags.enableCasperTests ?
            sp_build_common_1.parallel(spBuildCoreTasks.casperJSRunner, gulp_core_build_karma_1.default) : gulp_core_build_karma_1.default;
        testTask = sp_build_common_1.serial(testTask, gulp_core_build_1.jest);
        return sp_build_common_1.serial(this.getBundleTask(), testTask);
    }
    getCoreBuildTask() {
        return sp_build_common_1.parallel(sp_build_common_1.serial(gulp_core_build_sass_1.default, super.getCoreBuildTask()), gulp_core_build_1.copyStaticAssets);
    }
    getBundleTask() {
        return sp_build_common_1.serial(this.getBuildTask(), spBuildCoreTasks.collectLocalizedResources, spBuildCoreTasks.configureWebpack, gulp_core_build_webpack_1.default, // First webpack instance to create the base bundle
        spBuildCoreTasks.configureExternalBundlingWebpack, 
        // Second webpack instance to optionally expand the base bundle. This task is disabled if
        //  configureExternalBundlingWebpack isn't configured to do anything
        gulp_core_build_webpack_1.default, spBuildCoreTasks.copyAssets, spBuildCoreTasks.writeManifests);
    }
}
exports.SPWebBuildRig = SPWebBuildRig;

//# sourceMappingURL=SPWebBuildRig.js.map
