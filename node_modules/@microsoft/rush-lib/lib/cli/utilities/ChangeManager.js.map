{"version":3,"sources":["cli/utilities/ChangeManager.ts"],"names":[],"mappings":"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","file":"cli/utilities/ChangeManager.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport { IChangeInfo } from '../../data/ChangeManagement';\r\nimport { IChangelog } from '../../data/Changelog';\r\nimport IPackageJson from '../../utilities/IPackageJson';\r\nimport RushConfiguration from '../../data/RushConfiguration';\r\nimport RushConfigurationProject from '../../data/RushConfigurationProject';\r\nimport { VersionPolicy } from '../../data/VersionPolicy';\r\nimport { VersionPolicyConfiguration } from '../../data/VersionPolicyConfiguration';\r\nimport PublishUtilities, {\r\n  IChangeInfoHash\r\n} from './PublishUtilities';\r\nimport ChangeFiles from './ChangeFiles';\r\nimport PrereleaseToken from './PrereleaseToken';\r\nimport ChangelogGenerator from './ChangelogGenerator';\r\n\r\n/**\r\n * The class manages change files and controls how changes logged by change files\r\n * can be applied to package.json and change logs.\r\n */\r\nexport default class ChangeManager {\r\n  private _prereleaseToken: PrereleaseToken;\r\n  private _orderedChanges: IChangeInfo[];\r\n  private _allPackages: Map<string, RushConfigurationProject>;\r\n  private _allChanges: IChangeInfoHash;\r\n  private _changeFiles: ChangeFiles;\r\n\r\n  constructor(private _rushConfiguration: RushConfiguration,\r\n    private _lockStepProjectsToExclude?: Set<string> | undefined\r\n  ) {\r\n  }\r\n\r\n  /**\r\n   * Load changes from change files\r\n   * @param changesPath - location of change files\r\n   * @param prereleaseToken - prerelease token\r\n   * @param includeCommitDetails - whether commit details need to be included in changes\r\n   */\r\n  public load(\r\n    changesPath: string,\r\n    prereleaseToken: PrereleaseToken = new PrereleaseToken(),\r\n    includeCommitDetails: boolean = false\r\n  ): void {\r\n    this._allPackages = this._rushConfiguration.projectsByName;\r\n\r\n    this._prereleaseToken = prereleaseToken;\r\n\r\n    this._changeFiles = new ChangeFiles(changesPath);\r\n    this._allChanges = PublishUtilities.findChangeRequests(\r\n      this._allPackages,\r\n      this._changeFiles,\r\n      includeCommitDetails,\r\n      this._prereleaseToken,\r\n      this._lockStepProjectsToExclude\r\n      );\r\n    this._orderedChanges = PublishUtilities.sortChangeRequests(this._allChanges);\r\n  }\r\n\r\n  public hasChanges(): boolean {\r\n    return this._orderedChanges && this._orderedChanges.length > 0;\r\n  }\r\n\r\n  public get changes(): IChangeInfo[] {\r\n    return this._orderedChanges;\r\n  }\r\n\r\n  public get allPackages(): Map<string, RushConfigurationProject> {\r\n    return this._allPackages;\r\n  }\r\n\r\n  public validateChanges(versionConfig: VersionPolicyConfiguration): void {\r\n    Object\r\n      .keys(this._allChanges)\r\n      .filter((key) => {\r\n        const projectInfo: RushConfigurationProject | undefined = this._rushConfiguration.getProjectByName(key);\r\n        if (projectInfo) {\r\n          const versionPolicyName: string | undefined = projectInfo.versionPolicyName;\r\n          if (versionPolicyName) {\r\n            const changeInfo: IChangeInfo = this._allChanges[key];\r\n            const versionPolicy: VersionPolicy = versionConfig.getVersionPolicy(versionPolicyName);\r\n            versionPolicy.validate(changeInfo.newVersion!, key);\r\n          }\r\n        }\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Apply changes to package.json\r\n   * @param shouldCommit - If the value is true, package.json will be updated.\r\n   * If the value is false, package.json and change logs will not be updated. It will only do a dry-run.\r\n   */\r\n  public apply(shouldCommit: boolean): Map<string, IPackageJson> | undefined {\r\n    if (!this.hasChanges()) {\r\n      return;\r\n    }\r\n\r\n    // Apply all changes to package.json files.\r\n    const updatedPackages: Map<string, IPackageJson> = PublishUtilities.updatePackages(\r\n      this._allChanges,\r\n      this._allPackages,\r\n      shouldCommit,\r\n      this._prereleaseToken,\r\n      this._lockStepProjectsToExclude);\r\n\r\n    return updatedPackages;\r\n  }\r\n\r\n  public updateChangelog(shouldCommit: boolean, updatedPackages?: Map<string, IPackageJson>): void {\r\n    // Do not update changelog or delete the change files for prerelease.\r\n    // Save them for the official release.\r\n    if (!this._prereleaseToken.hasValue) {\r\n      // Update changelogs.\r\n      const updatedChangelogs: IChangelog[] = ChangelogGenerator.updateChangelogs(this._allChanges,\r\n        this._allPackages,\r\n        shouldCommit);\r\n\r\n      // Remove the change request files only if \"-a\" was provided.\r\n      this._changeFiles.deleteAll(shouldCommit, updatedChangelogs);\r\n    }\r\n  }\r\n}"],"sourceRoot":"..\\..\\..\\src"}