{"version":3,"sources":["cli/utilities/ChangeFiles.ts"],"names":[],"mappings":"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","file":"cli/utilities/ChangeFiles.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as fsx from 'fs-extra';\r\nimport { EOL } from 'os';\r\nimport * as glob from 'glob';\r\n\r\nimport Utilities from '../../utilities/Utilities';\r\nimport { IChangeInfo } from '../../data/ChangeManagement';\r\nimport { IChangelog } from '../../data/Changelog';\r\n\r\n/**\r\n * This class represents the collection of change files existing in the repo and provides operations\r\n * for those change files.\r\n */\r\nexport default class ChangeFiles {\r\n\r\n  // Change file path relative to changes folder.\r\n  private _files: string[];\r\n\r\n  /**\r\n   * Validate if the newly added change files match the changed packages.\r\n   */\r\n  public static validate(\r\n    newChangeFilePaths: string[],\r\n    changedPackages: string[]\r\n  ): void {\r\n    const changedSet: Set<string> = new Set<string>();\r\n    newChangeFilePaths.forEach((filePath) => {\r\n      console.log(`Found change file: ${filePath}`);\r\n      const changeRequest: IChangeInfo = JSON.parse(fsx.readFileSync(filePath, 'utf8'));\r\n      if (changeRequest && changeRequest.changes) {\r\n        changeRequest.changes!.forEach(change => {\r\n          changedSet.add(change.packageName);\r\n        });\r\n      } else {\r\n        throw new Error(`Invalid change file: ${filePath}`);\r\n      }\r\n    });\r\n\r\n    const requiredSet: Set<string> = new Set(changedPackages);\r\n    changedSet.forEach((name) => {\r\n      requiredSet.delete(name);\r\n    });\r\n    if (requiredSet.size > 0) {\r\n      const missingProjects: string[] = [];\r\n      requiredSet.forEach(name => {\r\n        missingProjects.push(name);\r\n      });\r\n      throw new Error(`Change file does not contain ${missingProjects.join(',')}.`);\r\n    }\r\n  }\r\n\r\n  public static getChangeComments(\r\n    newChangeFilePaths: string[],\r\n    changedPackages: string[]\r\n  ): Map<string, string[]> {\r\n    const changes: Map<string, string[]> = new Map<string, string[]>();\r\n\r\n    newChangeFilePaths.forEach((filePath) => {\r\n      console.log(`Found change file: ${filePath}`);\r\n      const changeRequest: IChangeInfo = JSON.parse(fsx.readFileSync(filePath, 'utf8'));\r\n      if (changeRequest && changeRequest.changes) {\r\n        changeRequest.changes!.forEach(change => {\r\n          if (!changes.get(change.packageName)) {\r\n            changes.set(change.packageName, []);\r\n          }\r\n          if (change.comment && change.comment.length) {\r\n            changes.get(change.packageName)!.push(change.comment);\r\n          }\r\n        });\r\n      } else {\r\n        throw new Error(`Invalid change file: ${filePath}`);\r\n      }\r\n    });\r\n    return changes;\r\n  }\r\n\r\n  constructor(private _changesPath: string) {\r\n  }\r\n\r\n  /**\r\n   * Get the array of absolute paths of change files.\r\n   */\r\n  public getFiles(): string[] {\r\n    if (this._files) {\r\n      return this._files;\r\n    }\r\n    this._files = glob.sync(`${this._changesPath}/**/*.json`);\r\n    return this._files || [];\r\n  }\r\n\r\n  /**\r\n   * Get the path of changes folder.\r\n   */\r\n  public getChangesPath(): string {\r\n    return this._changesPath;\r\n  }\r\n\r\n  /**\r\n   * Delete all change files\r\n   */\r\n  public deleteAll(shouldDelete: boolean, updatedChangelogs?: IChangelog[]): number {\r\n    if (updatedChangelogs) {\r\n      // Skip changes files if the package's change log is not updated.\r\n      const packagesToInclude: Set<string> = new Set<string>();\r\n      updatedChangelogs.forEach((changelog) => {\r\n        packagesToInclude.add(changelog.name);\r\n      });\r\n\r\n      const filesToDelete: string[] = this.getFiles().filter((filePath) => {\r\n        const changeRequest: IChangeInfo = JSON.parse(fsx.readFileSync(filePath, 'utf8'));\r\n        for (const changeInfo of changeRequest.changes!) {\r\n          if (!packagesToInclude.has(changeInfo.packageName)) {\r\n            return false;\r\n          }\r\n        }\r\n        return true;\r\n      });\r\n\r\n      return this._deleteFiles(filesToDelete, shouldDelete);\r\n    } else {\r\n      // Delete all change files.\r\n      return this._deleteFiles(this.getFiles(), shouldDelete);\r\n    }\r\n  }\r\n\r\n  private _deleteFiles(files: string[], shouldDelete: boolean): number {\r\n    if (files.length) {\r\n      console.log(\r\n        `${EOL}* ` +\r\n        `${shouldDelete ? 'DELETING:' : 'DRYRUN: Deleting'} ` +\r\n        `${files.length} change file(s).`\r\n      );\r\n\r\n      for (const filePath of files) {\r\n        console.log(` - ${filePath}`);\r\n\r\n        if (shouldDelete) {\r\n          Utilities.deleteFile(filePath);\r\n        }\r\n      }\r\n    }\r\n    return files.length;\r\n  }\r\n}"],"sourceRoot":"..\\..\\..\\src"}