{"version":3,"sources":["cli/utilities/VersionManager.ts"],"names":[],"mappings":"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","file":"cli/utilities/VersionManager.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as path from 'path';\r\nimport * as semver from 'semver';\r\nimport * as fsx from 'fs-extra';\r\nimport { cloneDeep } from 'lodash';\r\n\r\nimport {\r\n  VersionPolicy,\r\n  BumpType,\r\n  LockStepVersionPolicy\r\n} from '../../data/VersionPolicy';\r\nimport { ChangeFile } from '../../data/ChangeFile';\r\nimport { ChangeType, IChangeInfo } from '../../data/ChangeManagement';\r\nimport RushConfiguration from '../../data/RushConfiguration';\r\nimport RushConfigurationProject from '../../data/RushConfigurationProject';\r\nimport { VersionPolicyConfiguration } from '../../data/VersionPolicyConfiguration';\r\nimport IPackageJson from '../../utilities/IPackageJson';\r\nimport PublishUtilities from './PublishUtilities';\r\nimport ChangeManager from './ChangeManager';\r\n\r\nexport class VersionManager {\r\n  private _versionPolicyConfiguration: VersionPolicyConfiguration;\r\n  private _updatedProjects: Map<string, IPackageJson>;\r\n  private _changeFiles: Map<string, ChangeFile>;\r\n\r\n  constructor(private _rushConfiguration: RushConfiguration,\r\n    private _userEmail: string,\r\n    _versionPolicyConfiguration?: VersionPolicyConfiguration\r\n  ) {\r\n    this._versionPolicyConfiguration = _versionPolicyConfiguration ?\r\n      _versionPolicyConfiguration : this._rushConfiguration.versionPolicyConfiguration;\r\n\r\n    this._updatedProjects = new Map<string, IPackageJson>();\r\n    this._changeFiles = new Map<string, ChangeFile>();\r\n  }\r\n\r\n  /**\r\n   * Ensures project versions follow the provided version policy. If version policy is not\r\n   * provided, all projects will have their version checked according to the associated version policy.\r\n   * package.json files will be updated if needed.\r\n   * This method does not commit changes.\r\n   * @param versionPolicyName -- version policy name\r\n   * @param shouldCommit -- should update files to disk\r\n   */\r\n  public ensure(versionPolicyName?: string, shouldCommit?: boolean): void {\r\n    this._ensure(versionPolicyName, shouldCommit);\r\n  }\r\n\r\n  /**\r\n   * Bumps sversions following version policies.\r\n   *\r\n   * @param lockStepVersionPolicyName - a specified lock step version policy name. Without this value,\r\n   * versions for all lock step policies and all individual policies will be bumped.\r\n   * With this value, only the specified lock step policy will be bumped along with all individual policies.\r\n   * @param bumpType - overrides the default bump type and only works for lock step policy\r\n   * @param identifier - overrides the prerelease identifier and only works for lock step policy\r\n   * @param shouldCommit - whether the changes will be written to disk\r\n   */\r\n  public bump(lockStepVersionPolicyName?: string,\r\n    bumpType?: BumpType,\r\n    identifier?: string,\r\n    shouldCommit?: boolean\r\n  ): void {\r\n    // Bump all the lock step version policies.\r\n    this._versionPolicyConfiguration.bump(lockStepVersionPolicyName, bumpType, identifier, shouldCommit);\r\n\r\n    // Update packages and generate change files due to lock step bump.\r\n    this._ensure(lockStepVersionPolicyName, shouldCommit);\r\n\r\n    // Refresh rush configuration\r\n    this._rushConfiguration = RushConfiguration.loadFromConfigurationFile(this._rushConfiguration.rushJsonFile);\r\n\r\n    // Update projects based on individual policies\r\n    const changeManager: ChangeManager = new ChangeManager(this._rushConfiguration,\r\n      this._getLockStepProjects());\r\n    changeManager.load(this._rushConfiguration.changesFolder);\r\n    if (changeManager.hasChanges()) {\r\n      changeManager.validateChanges(this._versionPolicyConfiguration);\r\n      changeManager.apply(!!shouldCommit)!.forEach(packageJson => {\r\n        this._updatedProjects.set(packageJson.name, packageJson);\r\n      });\r\n      changeManager.updateChangelog(!!shouldCommit, this._updatedProjects);\r\n    }\r\n  }\r\n\r\n  public get updatedProjects(): Map<string, IPackageJson> {\r\n    return this._updatedProjects;\r\n  }\r\n\r\n  public get changeFiles(): Map<string, ChangeFile> {\r\n    return this._changeFiles;\r\n  }\r\n\r\n  private _ensure(versionPolicyName?: string, shouldCommit?: boolean): void {\r\n    this._updateVersionsByPolicy(versionPolicyName);\r\n\r\n    // Update all dependencies if needed.\r\n    this._updateDependencies();\r\n\r\n    if (shouldCommit) {\r\n      this._updatePackageJsonFiles();\r\n      this._changeFiles.forEach((changeFile) => {\r\n        changeFile.writeSync();\r\n      });\r\n    }\r\n  }\r\n\r\n  private _getLockStepProjects(): Set<string> | undefined {\r\n    const lockStepVersionPolicyNames: Set<string> = new Set<string>();\r\n\r\n    this._versionPolicyConfiguration.versionPolicies.forEach((versionPolicy) => {\r\n      if (versionPolicy instanceof LockStepVersionPolicy) {\r\n        lockStepVersionPolicyNames.add(versionPolicy.policyName);\r\n      }\r\n    });\r\n    const lockStepProjectNames: Set<string> = new Set<string>();\r\n    this._rushConfiguration.projects.forEach((rushProject) => {\r\n      if (lockStepVersionPolicyNames.has(rushProject.versionPolicyName!)) {\r\n        lockStepProjectNames.add(rushProject.packageName);\r\n      }\r\n    });\r\n    return lockStepProjectNames;\r\n  }\r\n\r\n  private _updateVersionsByPolicy(versionPolicyName?: string): void {\r\n    // Update versions based on version policy\r\n    this._rushConfiguration.projects.forEach(rushProject => {\r\n      const projectVersionPolicyName: string | undefined = rushProject.versionPolicyName;\r\n      if (projectVersionPolicyName &&\r\n          (!versionPolicyName || projectVersionPolicyName === versionPolicyName)) {\r\n        const versionPolicy: VersionPolicy = this._versionPolicyConfiguration.getVersionPolicy(\r\n          projectVersionPolicyName);\r\n        const updatedProject: IPackageJson | undefined = versionPolicy.ensure(rushProject.packageJson);\r\n        if (updatedProject) {\r\n          this._updatedProjects.set(updatedProject.name, updatedProject);\r\n\r\n          // No need to create an entry for prerelease version bump.\r\n          if (!this._isPrerelease(updatedProject.version)) {\r\n            this._addChangeInfo(updatedProject.name,\r\n              [this._createChangeInfo(updatedProject, rushProject)]);\r\n          }\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private _isPrerelease(version: string): boolean {\r\n    return !!semver.prerelease(version);\r\n  }\r\n\r\n  private _addChangeInfo(packageName: string,\r\n    changeInfos: IChangeInfo[]\r\n  ): void {\r\n    if (!changeInfos.length) {\r\n      return;\r\n    }\r\n    let changeFile: ChangeFile | undefined = this._changeFiles.get(packageName);\r\n    if (!changeFile) {\r\n      changeFile = new ChangeFile({\r\n        changes: [],\r\n        packageName: packageName,\r\n        email: this._userEmail\r\n      }, this._rushConfiguration);\r\n      this._changeFiles.set(packageName, changeFile);\r\n    }\r\n    changeInfos.forEach((changeInfo) => {\r\n      changeFile!.addChange(changeInfo);\r\n    });\r\n  }\r\n\r\n  private _updateDependencies(): void {\r\n    this._rushConfiguration.projects.forEach(rushProject => {\r\n      let clonedProject: IPackageJson | undefined = this._updatedProjects.get(rushProject.packageName);\r\n      let projectVersionChanged: boolean = true;\r\n      if (!clonedProject) {\r\n        clonedProject = cloneDeep(rushProject.packageJson);\r\n        projectVersionChanged = false;\r\n      }\r\n      this._updateProjectAllDependencies(rushProject, clonedProject, projectVersionChanged);\r\n    });\r\n  }\r\n\r\n  private _updateProjectAllDependencies(\r\n    rushProject: RushConfigurationProject,\r\n    clonedProject: IPackageJson,\r\n    projectVersionChanged: boolean\r\n  ): void {\r\n    if (!clonedProject.dependencies && !clonedProject.devDependencies) {\r\n      return;\r\n    }\r\n    const changes: IChangeInfo[] = [];\r\n    let updated: boolean = false;\r\n    if (this._updateProjectDependencies(clonedProject.dependencies, changes,\r\n      clonedProject, rushProject, projectVersionChanged)\r\n    ) {\r\n      updated = true;\r\n    }\r\n    if (this._updateProjectDependencies(clonedProject.devDependencies, changes,\r\n      clonedProject, rushProject, projectVersionChanged)\r\n    ) {\r\n      updated = true;\r\n    }\r\n\r\n    if (updated) {\r\n      this._updatedProjects.set(clonedProject.name, clonedProject);\r\n\r\n      this._addChangeInfo(clonedProject.name, changes);\r\n    }\r\n  }\r\n\r\n  private _updateProjectDependencies(dependencies: { [key: string]: string; } | undefined,\r\n    changes: IChangeInfo[],\r\n    clonedProject: IPackageJson,\r\n    rushProject: RushConfigurationProject,\r\n    projectVersionChanged: boolean\r\n  ): boolean {\r\n    if (!dependencies) {\r\n      return false;\r\n    }\r\n    let updated: boolean = false;\r\n    this._updatedProjects.forEach((updatedDependentProject, updatedDependentProjectName) => {\r\n      if (dependencies[updatedDependentProjectName]) {\r\n        if (rushProject.cyclicDependencyProjects.has(updatedDependentProjectName)) {\r\n          // Skip if cyclic\r\n          console.log(`Found cyclic ${rushProject.packageName} ${updatedDependentProjectName}`);\r\n          return;\r\n        }\r\n\r\n        const oldDependencyVersion: string = dependencies[updatedDependentProjectName];\r\n        const newDependencyVersion: string = PublishUtilities.getNewDependencyVersion(\r\n            dependencies,\r\n            updatedDependentProjectName,\r\n            updatedDependentProject.version\r\n          );\r\n\r\n        if (newDependencyVersion !== oldDependencyVersion) {\r\n          updated = true;\r\n          if (rushProject.shouldPublish) {\r\n            this._trackDependencyChange(changes, clonedProject, projectVersionChanged,\r\n              updatedDependentProject,\r\n              updatedDependentProjectName,\r\n              oldDependencyVersion,\r\n              newDependencyVersion\r\n            );\r\n          }\r\n          dependencies[updatedDependentProjectName] = newDependencyVersion;\r\n        }\r\n      }\r\n    });\r\n    return updated;\r\n  }\r\n\r\n  private _trackDependencyChange(\r\n    changes: IChangeInfo[],\r\n    clonedProject: IPackageJson,\r\n    projectVersionChanged: boolean,\r\n    updatedDependentProject: IPackageJson,\r\n    updatedDependentProjectName: string,\r\n    oldDependencyVersion: string,\r\n    newDependencyVersion: string\r\n  ): void {\r\n    if (!semver.satisfies(updatedDependentProject.version, oldDependencyVersion) && !projectVersionChanged) {\r\n      this._addChange(changes,\r\n        {\r\n          changeType: ChangeType.patch,\r\n          packageName: clonedProject.name\r\n        }\r\n      );\r\n    }\r\n\r\n    // If current version is not a prerelease version and new dependency is also not a prerelease version,\r\n    // add change entry. Otherwise, too many changes will be created for frequent releases.\r\n    if (!this._isPrerelease(updatedDependentProject.version) && !this._isPrerelease(clonedProject.version)) {\r\n      this._addChange(changes,\r\n        {\r\n          changeType: ChangeType.dependency,\r\n          comment: `Dependency ${updatedDependentProjectName} version bump from ${oldDependencyVersion}` +\r\n            ` to ${newDependencyVersion}.`,\r\n          packageName: clonedProject.name\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  private _addChange(changes: IChangeInfo[], newChange: IChangeInfo): void {\r\n    const exists: boolean = changes.some((changeInfo) => {\r\n      return (changeInfo.author === newChange.author &&\r\n        changeInfo.changeType === newChange.changeType &&\r\n        changeInfo.comment === newChange.comment &&\r\n        changeInfo.commit === newChange.commit &&\r\n        changeInfo.packageName === newChange.packageName &&\r\n        changeInfo.type === newChange.type\r\n      );\r\n    });\r\n    if (!exists) {\r\n      changes.push(newChange);\r\n    }\r\n  }\r\n\r\n  private _updatePackageJsonFiles(): void {\r\n    this._updatedProjects.forEach((newPackageJson, packageName) => {\r\n      const rushProject: RushConfigurationProject | undefined = this._rushConfiguration.getProjectByName(packageName);\r\n      // Update package.json\r\n      if (rushProject) {\r\n        const packagePath: string = path.join(rushProject.projectFolder, 'package.json');\r\n        fsx.writeFileSync(packagePath, JSON.stringify(newPackageJson, undefined, 2), { encoding: 'utf8' });\r\n      }\r\n    });\r\n  }\r\n\r\n  private _createChangeInfo(newPackageJson: IPackageJson,\r\n    rushProject: RushConfigurationProject\r\n  ): IChangeInfo {\r\n    return {\r\n      changeType: ChangeType.none,\r\n      newVersion: newPackageJson.version,\r\n      packageName: newPackageJson.name,\r\n      comment: `Package version bump from ${rushProject.packageJson.version} to ${newPackageJson.version}` +\r\n        ` by version policy`\r\n    };\r\n  }\r\n\r\n}"],"sourceRoot":"..\\..\\..\\src"}