{"version":3,"sources":["cli/actions/CustomRushAction.ts"],"names":[],"mappings":"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","file":"cli/actions/CustomRushAction.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as fsx from 'fs-extra';\r\nimport * as os from 'os';\r\nimport * as colors from 'colors';\r\n\r\nimport {\r\n  Event\r\n} from '../../index';\r\n\r\nimport {\r\n  CustomOption,\r\n  ICustomEnumValue\r\n} from '../../data/CommandLineConfiguration';\r\n\r\nimport {\r\n  CommandLineFlagParameter,\r\n  CommandLineIntegerParameter,\r\n  CommandLineStringListParameter,\r\n  CommandLineOptionParameter,\r\n  ICommandLineActionOptions\r\n} from '@microsoft/ts-command-line';\r\n\r\nimport RushCommandLineParser from './RushCommandLineParser';\r\nimport { BaseRushAction } from './BaseRushAction';\r\nimport { TaskSelector } from '../utilities/TaskSelector';\r\nimport { Stopwatch } from '../../utilities/Stopwatch';\r\n\r\ninterface ICustomOptionInstance {\r\n  optionDefinition: CustomOption;\r\n  parameterValue?: CommandLineFlagParameter | CommandLineOptionParameter;\r\n}\r\n\r\nexport class CustomRushAction extends BaseRushAction {\r\n  private customOptions: Map<string, ICustomOptionInstance> = new Map<string, ICustomOptionInstance>();\r\n\r\n  private _fromFlag: CommandLineStringListParameter;\r\n  private _toFlag: CommandLineStringListParameter;\r\n  private _verboseParameter: CommandLineFlagParameter;\r\n  private _parallelismParameter: CommandLineIntegerParameter | undefined;\r\n\r\n  constructor(private _parser: RushCommandLineParser,\r\n    options: ICommandLineActionOptions,\r\n    private _parallelized: boolean = false) {\r\n\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Registers a custom option to a task. This custom option is then registered during onDefineParameters()\r\n   * @param longName the long name of the option, e.g. \"--verbose\"\r\n   * @param option the Custom Option definition\r\n   */\r\n  public addCustomOption(longName: string, option: CustomOption): void {\r\n    if (this.customOptions.get(longName)) {\r\n      throw new Error(`Cannot define two custom options with the same name: \"${longName}\"`);\r\n    }\r\n    this.customOptions.set(longName, {\r\n      optionDefinition: option\r\n    });\r\n  }\r\n\r\n  public run(): void {\r\n    if (!fsx.existsSync(this.rushConfiguration.rushLinkJsonFilename)) {\r\n      throw new Error(`File not found: ${this.rushConfiguration.rushLinkJsonFilename}` +\r\n        `${os.EOL}Did you run \"rush link\"?`);\r\n    }\r\n    this.eventHooksManager.handle(Event.preRushBuild);\r\n\r\n    const stopwatch: Stopwatch = Stopwatch.start();\r\n\r\n    const isQuietMode: boolean = !(this._verboseParameter.value);\r\n\r\n    // if this is parallizable, then use the value from the flag (undefined or a number),\r\n    // if this is not parallelized, then use 1 core\r\n    const parallelism: number | undefined = this._isParallelized()\r\n      ? this._parallelismParameter!.value\r\n      : 1;\r\n\r\n    // collect all custom flags here\r\n    const customFlags: string[] = [];\r\n    this.customOptions.forEach((customOption: ICustomOptionInstance, longName: string) => {\r\n      if (customOption.parameterValue!.value) {\r\n        if (customOption.optionDefinition.optionType === 'flag') {\r\n          customFlags.push(longName);\r\n        } else if (customOption.optionDefinition.optionType === 'enum') {\r\n          customFlags.push(`${longName} ${customOption.parameterValue!.value}`);\r\n        }\r\n      }\r\n    });\r\n\r\n    const tasks: TaskSelector = new TaskSelector(\r\n      {\r\n        rushConfiguration: this._parser.rushConfig,\r\n        toFlags: this._toFlag.value,\r\n        fromFlags: this._fromFlag.value,\r\n        commandToRun: this.options.actionVerb,\r\n        customFlags,\r\n        isQuietMode,\r\n        parallelism,\r\n        isIncrementalBuildAllowed: this.options.actionVerb === 'build'\r\n      }\r\n    );\r\n\r\n    tasks.execute().then(\r\n      () => {\r\n        stopwatch.stop();\r\n        console.log(colors.green(`rush ${this.options.actionVerb} (${stopwatch.toString()})`));\r\n        this._collectTelemetry(stopwatch, true);\r\n        this._parser.flushTelemetry();\r\n        this.eventHooksManager.handle(Event.postRushBuild, this._parser.isDebug);\r\n      },\r\n      () => {\r\n        stopwatch.stop();\r\n        console.log(colors.red(`rush ${this.options.actionVerb} - Errors! (${stopwatch.toString()})`));\r\n        this._collectTelemetry(stopwatch, false);\r\n        this._parser.flushTelemetry();\r\n        this.eventHooksManager.handle(Event.postRushBuild, this._parser.isDebug);\r\n        this._parser.exitWithError();\r\n      });\r\n  }\r\n\r\n  protected onDefineParameters(): void {\r\n    if (this._isParallelized()) {\r\n      this._parallelismParameter = this.defineIntegerParameter({\r\n        parameterLongName: '--parallelism',\r\n        parameterShortName: '-p',\r\n        key: 'COUNT',\r\n        description: 'Specify the number of concurrent build processes.'\r\n          + ' If omitted, the parallelism will be based on the number of CPU cores.'\r\n      });\r\n    }\r\n    this._toFlag = this.defineStringListParameter({\r\n      parameterLongName: '--to',\r\n      parameterShortName: '-t',\r\n      key: 'PROJECT1',\r\n      description: 'Run command in the specified project and all of its dependencies'\r\n    });\r\n    this._fromFlag = this.defineStringListParameter({\r\n      parameterLongName: '--from',\r\n      parameterShortName: '-f',\r\n      key: 'PROJECT2',\r\n      description: 'Run command in all projects that directly or indirectly depend on the specified project'\r\n    });\r\n    this._verboseParameter = this.defineFlagParameter({\r\n      parameterLongName: '--verbose',\r\n      parameterShortName: '-v',\r\n      description: 'Display the logs during the build, rather than just displaying the build status summary'\r\n    });\r\n\r\n    // @TODO we should throw if they are trying to overwrite built in flags\r\n\r\n    this.customOptions.forEach((customOption: ICustomOptionInstance, longName: string) => {\r\n      if (customOption.optionDefinition.optionType === 'flag') {\r\n        customOption.parameterValue = this.defineFlagParameter({\r\n          parameterShortName: customOption.optionDefinition.shortName,\r\n          parameterLongName: longName,\r\n          description: customOption.optionDefinition.description\r\n        });\r\n      } else if (customOption.optionDefinition.optionType === 'enum') {\r\n        customOption.parameterValue = this.defineOptionParameter({\r\n          parameterShortName: customOption.optionDefinition.shortName,\r\n          parameterLongName: longName,\r\n          description: customOption.optionDefinition.description,\r\n          defaultValue: customOption.optionDefinition.defaultValue,\r\n          options: customOption.optionDefinition.enumValues.map((enumValue: ICustomEnumValue) => {\r\n              return enumValue.name;\r\n            })\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  private _isParallelized(): boolean {\r\n    return this.options.actionVerb === 'build'\r\n      || this.options.actionVerb === 'rebuild'\r\n      || this._parallelized;\r\n  }\r\n\r\n  private _collectTelemetry(stopwatch: Stopwatch, success: boolean): void {\r\n    const extraData: { [key: string]: string } = {\r\n      command_to: (!!this._toFlag.value).toString(),\r\n      command_from: (!!this._fromFlag.value).toString()\r\n    };\r\n\r\n    this.customOptions.forEach((customOption: ICustomOptionInstance, longName: string) => {\r\n      if (customOption.parameterValue!.value) {\r\n        extraData[`${this.options.actionVerb}_${longName}`] =\r\n          customOption.parameterValue!.value.toString();\r\n      }\r\n    });\r\n\r\n    if (this._parser.telemetry) {\r\n      this._parser.telemetry.log({\r\n        name: this.options.actionVerb,\r\n        duration: stopwatch.duration,\r\n        result: success ? 'Succeeded' : 'Failed',\r\n        extraData\r\n      });\r\n    }\r\n  }\r\n}"],"sourceRoot":"..\\..\\..\\src"}