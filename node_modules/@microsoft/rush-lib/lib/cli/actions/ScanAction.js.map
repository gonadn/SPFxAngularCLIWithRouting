{"version":3,"sources":["cli/actions/ScanAction.ts"],"names":[],"mappings":";AAAA,4FAA4F;AAC5F,2DAA2D;;AAE3D,iCAAiC;AACjC,gCAAgC;AAChC,6BAA6B;AAC7B,6BAA6B;AAC7B,gDAAiD;AAGjD,qDAAkD;AAElD,gBAAgC,SAAQ,+BAAc;IAGpD,YAAY,MAA6B;QACvC,KAAK,CAAC;YACJ,UAAU,EAAE,MAAM;YAClB,OAAO,EAAE,4EAA4E;YACrF,aAAa,EAAE,2EAA2E;kBACtF,+EAA+E;kBAC/E,mFAAmF;kBACnF,2EAA2E;kBAC3E,mFAAmF;kBACnF,iFAAiF;kBACjF,iFAAiF;kBACjF,iCAAiC;SACtC,CAAC,CAAC;QACH,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC;IACxB,CAAC;IAES,kBAAkB;QAC1B,WAAW;IACb,CAAC;IAES,GAAG;QACX,MAAM,mBAAmB,GAAW,IAAI,CAAC,OAAO,CAAC,gBAAgB,CAAC,CAAC;QAEnE,EAAE,CAAC,CAAC,CAAC,GAAG,CAAC,UAAU,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC;YACzC,MAAM,IAAI,KAAK,CAAC,8EAA8E,CAAC,CAAC;QAClG,CAAC;QAED,MAAM,cAAc,GAAa;YAC/B,+BAA+B;YAC/B,qCAAqC;YACrC,qCAAqC;YAErC,sCAAsC;YACtC,4CAA4C;YAC5C,4CAA4C;YAE5C,uCAAuC;YACvC,6CAA6C;YAC7C,6CAA6C;YAE7C,qCAAqC;YACrC,2CAA2C;YAC3C,2CAA2C;YAE3C,WAAW;YACX,EAAE;YACF,WAAW;YACX,SAAS;YACT,sBAAsB;YACtB,wBAAwB;YACxB,wBAAwB;YAExB,gCAAgC;YAChC,+BAA+B;YAC/B,+BAA+B;YAE/B,WAAW;YACX,sCAAsC;YACtC,0DAA0D;SAC3D,CAAC;QAEF,qDAAqD;QACrD,iDAAiD;QACjD,MAAM,aAAa,GAAW,wCAAwC,CAAC;QAEvE,MAAM,cAAc,GAAgB,IAAI,GAAG,EAAU,CAAC;QAEtD,GAAG,CAAC,CAAC,MAAM,QAAQ,IAAI,IAAI,CAAC,IAAI,CAAC,wDAAwD,CAAC,CAAC,CAAC,CAAC;YAC3F,IAAI,CAAC;gBACH,MAAM,QAAQ,GAAW,GAAG,CAAC,YAAY,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAC;gBAC5D,MAAM,KAAK,GAAa,QAAQ,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;gBAE7C,GAAG,CAAC,CAAC,MAAM,IAAI,IAAI,KAAK,CAAC,CAAC,CAAC;oBACzB,GAAG,CAAC,CAAC,MAAM,aAAa,IAAI,cAAc,CAAC,CAAC,CAAC;wBAC3C,MAAM,mBAAmB,GAA2B,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;wBAC7E,EAAE,CAAC,CAAC,mBAAmB,CAAC,CAAC,CAAC;4BACxB,cAAc,CAAC,GAAG,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC,CAAC;wBAC7C,CAAC;oBACH,CAAC;gBACH,CAAC;YACH,CAAC;YAAC,KAAK,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC;gBACf,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,8BAA8B,GAAG,QAAQ,CAAC,CAAC,CAAC;YACtE,CAAC;QACH,CAAC;QAED,MAAM,cAAc,GAAgB,IAAI,GAAG,EAAU,CAAC;QAEtD,cAAc,CAAC,OAAO,CAAC,CAAC,YAAoB;YAC1C,MAAM,mBAAmB,GAA2B,aAAa,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;YACrF,EAAE,CAAC,CAAC,mBAAmB,CAAC,CAAC,CAAC;gBACxB,cAAc,CAAC,GAAG,CAAC,mBAAmB,CAAC,CAAC,CAAC,CAAC,CAAC;YAC7C,CAAC;QACH,CAAC,CAAC,CAAC;QAEH,MAAM,YAAY,GAAa,EAAE,CAAC;QAElC,cAAc,CAAC,OAAO,CAAC,CAAC,WAAmB;YACzC,YAAY,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC;QACjC,CAAC,CAAC,CAAC;QAEH,YAAY,CAAC,IAAI,EAAE,CAAC;QAEpB,OAAO,CAAC,GAAG,CAAC,wBAAwB,CAAC,CAAC;QACtC,GAAG,CAAC,CAAC,MAAM,WAAW,IAAI,YAAY,CAAC,CAAC,CAAC;YACvC,EAAE,CAAC,CAAC,mBAAmB,CAAC,OAAO,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;gBACjD,OAAO,CAAC,GAAG,CAAC,IAAI,GAAG,WAAW,CAAC,CAAC;YAClC,CAAC;QACH,CAAC;IACH,CAAC;CACF;AAhHD,6BAgHC","file":"cli/actions/ScanAction.js","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as colors from 'colors';\r\nimport * as fsx from 'fs-extra';\r\nimport * as glob from 'glob';\r\nimport * as path from 'path';\r\nimport builtinPackageNames = require('builtins');\r\n\r\nimport RushCommandLineParser from './RushCommandLineParser';\r\nimport { BaseRushAction } from './BaseRushAction';\r\n\r\nexport default class ScanAction extends BaseRushAction {\r\n  private _parser: RushCommandLineParser;\r\n\r\n  constructor(parser: RushCommandLineParser) {\r\n    super({\r\n      actionVerb: 'scan',\r\n      summary: 'Scan the current project folder and display a report of imported packages.',\r\n      documentation: `The NPM system allows a project to import dependencies without explicitly`\r\n        + ` listing them in its package.json file. This is a dangerous practice, because`\r\n        + ` there is no guarantee you will get a compatible version. The \"rush scan\" command`\r\n        + ` reports a list of packages that are imported by your code, which you can`\r\n        + ` compare against your package.json file to find mistakes. It searches the \"./src\"`\r\n        + ` and \"./lib\" folders for typical import syntaxes such as \"import __ from '__'\",`\r\n        + ` \"require('__')\", \"System.import('__'), etc.  The results are only approximate,`\r\n        + ` but generally pretty accurate.`\r\n    });\r\n    this._parser = parser;\r\n  }\r\n\r\n  protected onDefineParameters(): void {\r\n    // abstract\r\n  }\r\n\r\n  protected run(): void {\r\n    const packageJsonFilename: string = path.resolve('./package.json');\r\n\r\n    if (!fsx.existsSync(packageJsonFilename)) {\r\n      throw new Error('You must run \"rush scan\" in a project folder containing a package.json file.');\r\n    }\r\n\r\n    const requireRegExps: RegExp[] = [\r\n      // Example: require('someting')\r\n      /\\brequire\\s*\\(\\s*[']([^']+\\s*)[']\\)/,\r\n      /\\brequire\\s*\\(\\s*[\"]([^\"]+)[\"]\\s*\\)/,\r\n\r\n      // Example: require.ensure('someting')\r\n      /\\brequire.ensure\\s*\\(\\s*[']([^']+\\s*)[']\\)/,\r\n      /\\brequire.ensure\\s*\\(\\s*[\"]([^\"]+)[\"]\\s*\\)/,\r\n\r\n      // Example: require.resolve('someting')\r\n      /\\brequire.resolve\\s*\\(\\s*[']([^']+\\s*)[']\\)/,\r\n      /\\brequire.resolve\\s*\\(\\s*[\"]([^\"]+)[\"]\\s*\\)/,\r\n\r\n      // Example: System.import('someting')\r\n      /\\bSystem.import\\s*\\(\\s*[']([^']+\\s*)[']\\)/,\r\n      /\\bSystem.import\\s*\\(\\s*[\"]([^\"]+)[\"]\\s*\\)/,\r\n\r\n      // Example:\r\n      //\r\n      // import {\r\n      //   A, B\r\n      // } from 'something';\r\n      /\\bfrom\\s*[']([^']+)[']/,\r\n      /\\bfrom\\s*[\"]([^\"]+)[\"]/,\r\n\r\n      // Example:  import 'something';\r\n      /\\bimport\\s*[']([^']+)[']\\s*\\;/,\r\n      /\\bimport\\s*[\"]([^\"]+)[\"]\\s*\\;/,\r\n\r\n      // Example:\r\n      // /// <reference types=\"something\" />\r\n      /\\/\\/\\/\\s*<\\s*reference\\s+types\\s*=\\s*[\"]([^\"]+)[\"]\\s*\\/>/\r\n    ];\r\n\r\n    // Example: \"my-package/lad/dee/dah\" --> \"my-package\"\r\n    // Example: \"@ms/my-package\" --> \"@ms/my-package\"\r\n    const packageRegExp: RegExp = /^((@[a-z\\-0-9!_]+\\/)?[a-z\\-0-9!_]+)\\/?/;\r\n\r\n    const requireMatches: Set<string> = new Set<string>();\r\n\r\n    for (const filename of glob.sync('{./*.{ts,js,tsx,jsx},./{src,lib}/**/*.{ts,js,tsx,jsx}}')) {\r\n      try {\r\n        const contents: string = fsx.readFileSync(filename, 'utf8');\r\n        const lines: string[] = contents.split('\\n');\r\n\r\n        for (const line of lines) {\r\n          for (const requireRegExp of requireRegExps) {\r\n            const requireRegExpResult: RegExpExecArray | null = requireRegExp.exec(line);\r\n            if (requireRegExpResult) {\r\n              requireMatches.add(requireRegExpResult[1]);\r\n            }\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.log(colors.bold('Skipping file due to error: ' + filename));\r\n      }\r\n    }\r\n\r\n    const packageMatches: Set<string> = new Set<string>();\r\n\r\n    requireMatches.forEach((requireMatch: string) => {\r\n      const packageRegExpResult: RegExpExecArray | null = packageRegExp.exec(requireMatch);\r\n      if (packageRegExpResult) {\r\n        packageMatches.add(packageRegExpResult[1]);\r\n      }\r\n    });\r\n\r\n    const packageNames: string[] = [];\r\n\r\n    packageMatches.forEach((packageName: string) => {\r\n      packageNames.push(packageName);\r\n    });\r\n\r\n    packageNames.sort();\r\n\r\n    console.log('Detected dependencies:');\r\n    for (const packageName of packageNames) {\r\n      if (builtinPackageNames.indexOf(packageName) < 0) {\r\n        console.log('  ' + packageName);\r\n      }\r\n    }\r\n  }\r\n}\r\n"],"sourceRoot":"..\\..\\..\\src"}