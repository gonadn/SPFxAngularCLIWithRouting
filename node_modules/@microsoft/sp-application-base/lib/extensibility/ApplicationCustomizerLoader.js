"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var sp_telemetry_1 = require("@ms/sp-telemetry");
var sp_core_library_1 = require("@microsoft/sp-core-library");
var sp_loader_1 = require("@microsoft/sp-loader");
var sp_extension_base_1 = require("@microsoft/sp-extension-base");
var BaseApplicationCustomizer_1 = require("./BaseApplicationCustomizer");
var ApplicationCustomizerContext_1 = require("./ApplicationCustomizerContext");
var ClientSideCustomAction_1 = require("./customAction/ClientSideCustomAction");
var ClientSideCustomActionContext_1 = require("./customAction/ClientSideCustomActionContext");
var CustomActionLocations_1 = require("./customAction/CustomActionLocations");
var PlaceholderManager_1 = require("./placeholder/PlaceholderManager");
var ApplicationCustomizerLoader = (function () {
    function ApplicationCustomizerLoader(serviceScope, pageContext, spHttpClient, customActions) {
        var _this = this;
        this._customActionContext = new ClientSideCustomActionContext_1.default();
        sp_core_library_1.Validate.isNotNullOrUndefined(serviceScope, 'serviceScope');
        sp_core_library_1.Validate.isNotNullOrUndefined(pageContext, 'pageContext');
        sp_core_library_1.Validate.isNotNullOrUndefined(spHttpClient, 'spHttpClient');
        this._extensionManager = new sp_extension_base_1._ExtensionManager(serviceScope, BaseApplicationCustomizer_1.default);
        this._pageContext = pageContext;
        this._spHttpClient = spHttpClient;
        this._customActions = customActions ? customActions : [];
        for (var _i = 0, _a = this._customActions; _i < _a.length; _i++) {
            var customAction = _a[_i];
            if (customAction.location === CustomActionLocations_1.default.APPLICATION_CUSTOMIZER) {
                var clientSideCustomAction = ClientSideCustomAction_1.default._tryCreateFromPreloadedCustomAction(customAction);
                if (clientSideCustomAction) {
                    this._customActionContext.customActions.push(clientSideCustomAction);
                }
            }
        }
        serviceScope.whenFinished(function () {
            _this._placeholderManager = serviceScope.consume(PlaceholderManager_1.default.serviceKey);
            _this._placeholderManager._enable();
        });
    }
    ApplicationCustomizerLoader.prototype.loadExtensions = function () {
        this._parseCustomActionsQueryParameter();
        var extensionPromises = [];
        var customActions = this._customActionContext.getAll();
        for (var _i = 0, customActions_1 = customActions; _i < customActions_1.length; _i++) {
            var customAction = customActions_1[_i];
            if (customAction.location === CustomActionLocations_1.default.APPLICATION_CUSTOMIZER) {
                extensionPromises.push(this._createApplicationCustomizer(customAction));
            }
        }
        return Promise.all(extensionPromises).then(function (extensions) { return; });
    };
    ApplicationCustomizerLoader.prototype._createApplicationCustomizer = function (customAction) {
        var _this = this;
        var qosMonitor = new sp_telemetry_1._QosMonitor('ApplicationCustomizer.Create');
        return this._extensionManager.createExtension(customAction.clientSideComponentId.toString(), customAction.clientSideComponentProperties, function (extensionContextParameters) {
            return new ApplicationCustomizerContext_1.default(extensionContextParameters, {
                sequence: customAction.sequence !== undefined ? customAction.sequence : 65535 
            });
        }).then(function (extension) {
            qosMonitor.writeSuccess(_this._createQosExtraData(customAction));
            return extension;
        }).catch(function (error) {
            var err = new Error("Failed to create application customizer '" + customAction.tag + "'. Error information is '" + error.message + "'."); 
            qosMonitor.writeExpectedFailure('FailedCreateExtension', error, _this._createQosExtraData(customAction));
            sp_telemetry_1._TraceLogger.logError(ApplicationCustomizerLoader._logSource, err);
            throw err;
        });
    };
    ApplicationCustomizerLoader.prototype._createQosExtraData = function (customAction) {
        return {
            customAction: customAction.tag
        };
    };
    ApplicationCustomizerLoader.prototype._parseCustomActionsQueryParameter = function () {
        var parameters = new sp_core_library_1.UrlQueryParameterCollection(window.location.href);
        var parameterValue = parameters.getValue('customActions');
        if (parameterValue) {
            var qosMonitor = new sp_telemetry_1._QosMonitor('ApplicationCustomizerLoader.parseQueryParam');
            try {
                var decodedParameterValue = decodeURIComponent(parameterValue);
                var queryValue = JSON.parse(decodedParameterValue);
                var missingManifestIds = [];
                if (queryValue) {
                    for (var _i = 0, _a = Object.keys(queryValue); _i < _a.length; _i++) {
                        var key = _a[_i];
                        var clientSideComponentId = sp_core_library_1.Guid.tryParse(key);
                        var location_1 = queryValue[key].location;
                        var properties = queryValue[key].properties;
                        var sequence = queryValue[key].sequence;
                        sp_core_library_1.Validate.isNotNullOrUndefined(clientSideComponentId, 'clientSideComponentId');
                        sp_core_library_1.Validate.isNotNullOrUndefined(location_1, 'location');
                        if (!sp_loader_1.SPComponentLoader.tryGetManifestById(clientSideComponentId.toString())) {
                            missingManifestIds.push(clientSideComponentId);
                            continue; 
                        }
                        if (clientSideComponentId && location_1) {
                            var customActions = ClientSideCustomAction_1.default._tryCreateFromDebugData(location_1, clientSideComponentId, properties ? JSON.stringify(properties) : '', sequence);
                            if (customActions) {
                                this._customActionContext.debugCustomActions.push(customActions);
                            }
                        }
                    }
                }
                if (missingManifestIds.length > 0) {
                    this._processMissingManifestsErrors(missingManifestIds, qosMonitor);
                }
                else {
                    qosMonitor.writeSuccess();
                }
            }
            catch (e) {
                this._processQueryParamParseErrors(e, parameterValue, qosMonitor);
            }
        }
    };
    ApplicationCustomizerLoader.prototype._processMissingManifestsErrors = function (missingManifestIds, qosMonitor) {
        var errorMessage = 'Custom action component ids are specified by query parameters but ' +
            'matching manifests cannot be found.';
        var error = new Error(errorMessage + ' Ids: ' + missingManifestIds.join(', '));
        sp_telemetry_1._TraceLogger.logError(ApplicationCustomizerLoader._logSource, error, 'parseCustomActionsQueryParameter');
        console.error(error.message);
        qosMonitor.writeExpectedFailure('ManifestNotFound', error);
    };
    ApplicationCustomizerLoader.prototype._processQueryParamParseErrors = function (error, parameterValue, qosMonitor) {
        sp_telemetry_1._TraceLogger.logError(ApplicationCustomizerLoader._logSource, new Error('Failed to parse the "customActions" URL query parameter:' + error.message));
        console.error('The "customActions" URL query parameter is improperly formatted: '
            + decodeURIComponent(parameterValue));
        qosMonitor.writeExpectedFailure('ParseFailure', error);
    };
    ApplicationCustomizerLoader._logSource = sp_telemetry_1._LogSource.create('ApplicationCustomizerLoader');
    return ApplicationCustomizerLoader;
}());
exports.default = ApplicationCustomizerLoader;
