"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const coreBuild = require("@microsoft/gulp-core-build");
const sp_tslint_rules_1 = require("@microsoft/sp-tslint-rules");
const gulp_core_build_typescript_1 = require("@microsoft/gulp-core-build-typescript");
const BuildRig_1 = require("./BuildRig");
const BuildRigConstants_1 = require("./BuildRigConstants");
exports.preCopy = new coreBuild.CopyTask();
exports.postCopy = new coreBuild.CopyTask();
/**
 * This class represents the basic shared build rig for all SPFx Rigs. It defines a few
 * simple sub-tasks, and only registers a "build" task.
 */
class SPBuildRig extends BuildRig_1.BuildRig {
    constructor() {
        super(...arguments);
        this._preBuildTasks = [];
        this._postTypescriptTasks = [];
        this._postBuildTasks = [];
    }
    initialize(gulp) {
        super.initialize(gulp);
    }
    /**
     * Register additional sub-tasks to run before the typescript subtask.
     * Note, this is meant to be used in a gulpfile.js to inject one-off subtasks
     */
    addPreBuildTask(tasks) {
        this._addTaskOrListOfTasks(tasks, this._preBuildTasks);
    }
    /**
     * Register additional sub-tasks to run after the typescript subtask.
     * Note, this is meant to be used in a gulpfile.js to inject one-off subtasks
     */
    addPostTypescriptTask(tasks) {
        this._addTaskOrListOfTasks(tasks, this._postTypescriptTasks);
    }
    /**
     * Register additional sub-tasks to run after the typescript subtask.
     * @deprecated
     */
    addBuildTasks(tasks) {
        this._addTaskOrListOfTasks(tasks, this._postTypescriptTasks);
    }
    /**
     * Register additional sub-tasks to run after the entire build.
     * Note, this is meant to be used in a gulpfile.js to inject one-off subtasks
     */
    addPostBuildTask(tasks) {
        this._addTaskOrListOfTasks(tasks, this._postBuildTasks);
    }
    /**
     * Registers the command line arguments which are available for this rig
     * @todo 253519 this code should be moved into gulp-core-build/the task definitions
     */
    getYargs() {
        return super.getYargs()
            .option('locale', {
            alias: 'l',
            describe: 'override the default culture (e.g. "fr-fr")',
            type: 'string'
        })
            .option('minimal', {
            alias: 'm',
            describe: 'Speeds up the build by running the minimal set of tasks required to produce an executable output',
            type: 'boolean'
        })
            .command(BuildRigConstants_1.BuildRigConstants.tasks.build, 'build the project')
            .command(BuildRigConstants_1.BuildRigConstants.tasks.default, 'equivalent to bundle');
    }
    /**
     * Register 2 tasks, build and default, which simply copy files, then run typescript and tslint
     */
    getTasks() {
        const result = new Map();
        result.set(BuildRigConstants_1.BuildRigConstants.tasks.build, { executable: this.getBuildTask() });
        result.set(BuildRigConstants_1.BuildRigConstants.tasks.default, { executable: this.getBuildTask() });
        return result;
    }
    /**
     * Override this function to overwrite the "build" task
     */
    getBuildTask() {
        return coreBuild.serial(exports.preCopy, coreBuild.serial(this._preBuildTasks), this.getCoreBuildTask(), coreBuild.serial(this._postBuildTasks), exports.postCopy);
    }
    /**
     * Override this function to redefine the core build loop
     */
    getCoreBuildTask() {
        return coreBuild.parallel(gulp_core_build_typescript_1.tslint, coreBuild.serial(coreBuild.serial(gulp_core_build_typescript_1.typescript, gulp_core_build_typescript_1.removeTripleSlash, gulp_core_build_typescript_1.apiExtractor), coreBuild.serial(...this._postTypescriptTasks)));
    }
    setupSharedConfig() {
        // Ensure that the SPFx tslint rules are activated
        sp_tslint_rules_1.initializeTslintTask(gulp_core_build_typescript_1.tslint);
        gulp_core_build_typescript_1.tslint.mergeConfig({
            displayAsWarning: true
        });
        exports.preCopy.name = 'pre-copy';
        exports.postCopy.name = 'post-copy';
        gulp_core_build_typescript_1.apiExtractor.mergeConfig({
            apiJsonFolder: path.join(process.cwd(), 'dist')
        });
    }
    /**
     * This function cleans up the shared config by populating task config properties that depend on other tasks'
     *  user-defined properties.
     */
    finalizeSharedConfig() {
        if (this.args.minimal) {
            this._disableTasks(gulp_core_build_typescript_1.tslint, gulp_core_build_typescript_1.apiExtractor);
        }
    }
    _addTaskOrListOfTasks(tasks, array) {
        if (tasks.length) {
            array.push(...tasks);
        }
        else {
            array.push(tasks);
        }
    }
}
exports.SPBuildRig = SPBuildRig;

//# sourceMappingURL=SPBuildRig.js.map
